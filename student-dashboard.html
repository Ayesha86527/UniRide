<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - UniRide</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; }
        .ride-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; }
        .btn-danger { background-color: #dc3545; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 4px; }
        .search-box { margin-bottom: 20px; }
        input { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Student Dashboard</h1>
            <button class="btn-danger" onclick="logout()">Logout</button>
        </header>

        <p>Welcome, <span id="studentName">Student</span>!</p>

        <div class="search-box">
            <h2>Search Rides</h2>
            <input type="text" id="searchFrom" placeholder="From (e.g. Campus)">
            <input type="text" id="searchTo" placeholder="To (e.g. Station)">
            <button class="btn-primary" onclick="searchRides()">Search</button>
        </div>

        <div id="availableRides"></div>

        <hr>

        <h2>My Booked Rides</h2>
        <div id="bookedRides"></div>
    </div>

    <script>
        // Student name initialization
        const name = prompt("Please enter your name:");
        if (name) {
            document.getElementById('studentName').innerText = name;
        }

        function logout() {
            window.location.href = 'index.html';
        }

        // Load rides from localStorage
        let driverRides = JSON.parse(localStorage.getItem('driverRides') || '[]');
        let bookedRides = JSON.parse(localStorage.getItem('bookedRides') || '[]');
        let filteredRides = [];

        function updateBookedRides() {
            const bookedDiv = document.getElementById('bookedRides');
            if (bookedRides.length === 0) {
                bookedDiv.innerHTML = "<p>No rides booked yet.</p>";
                return;
            }

            bookedDiv.innerHTML = bookedRides.map(r => `
                <div class="ride-item">
                    <p>${r.from} → ${r.to} | ${new Date(r.time).toLocaleString()}</p>
                </div>
            `).join('');
        }

        function searchRides() {
            const from = document.getElementById('searchFrom').value.toLowerCase();
            const to = document.getElementById('searchTo').value.toLowerCase();

            // Map rides to include their original index to identify them uniquely regardless of filtering
            filteredRides = driverRides
                .map((r, index) => ({ ...r, originalIndex: index }))
                .filter(r => 
                    r.from.toLowerCase().includes(from) && 
                    r.to.toLowerCase().includes(to) && 
                    r.seats > 0
                );

            const availableDiv = document.getElementById('availableRides');
            if (filteredRides.length === 0) {
                availableDiv.innerHTML = "<p>No rides found for this route.</p>";
                return;
            }

            availableDiv.innerHTML = filteredRides.map(r => `
                <div class="ride-item">
                    <p>${r.from} → ${r.to} | ${new Date(r.time).toLocaleString()} | Seats: ${r.seats}</p>
                    <button class="btn-primary" onclick="bookRide(${r.originalIndex})">Book</button>
                </div>
            `).join('');
        }

        function bookRide(originalIndex) {
            const ride = driverRides[originalIndex];

            if (!ride || ride.seats <= 0) {
                alert("No seats available!");
                return;
            }

            // Decrement seats in the original array
            ride.seats--;
            
            // Restore object cloning to prevent shared reference side effects
            bookedRides.push({ ...ride });

            localStorage.setItem('driverRides', JSON.stringify(driverRides));
            localStorage.setItem('bookedRides', JSON.stringify(bookedRides));

            alert("Ride booked successfully!");
            searchRides(); // Refresh search view
            updateBookedRides(); // Refresh booked list
        }

        // Initial UI render
        updateBookedRides();
    </script>
</body>
</html>